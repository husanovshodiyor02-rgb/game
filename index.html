<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üöó Mashina Jangi ‚Äî 3D shahar & real tovush</title>
<style>
  :root{
    --bg:#071026; --road:#2b2b2b; --lane:#dcdcdc; --accent:#60a5fa;
    --hud-bg: rgba(0,0,0,0.45);
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#041224,#07102a);color:#fff;overflow:hidden}
  /* parallax city */
  #city{position:fixed;inset:0;z-index:0;pointer-events:none}
  .layer{position:absolute;left:50%;top:50%;transform-origin:center;will-change:transform}
  .layer.far{width:2000px;height:420px;transform:translate3d(-50%,-60%,-300px) scale(1.05);filter:blur(6px) saturate(.9);opacity:.75;background:linear-gradient(180deg,#06122a,#07102a)}
  .layer.mid{width:2000px;height:420px;transform:translate3d(-50%,-50%,-120px) scale(.98);background:linear-gradient(180deg,#071733,#051226)}
  .layer.near{width:2000px;height:340px;transform:translate3d(-50%,-40%,-40px) scale(1);background:linear-gradient(180deg,#072033,#031827)}
  .lights{position:absolute;inset:auto 0 100px 0;height:120px}
  .light{position:absolute;bottom:40px;width:8px;height:8px;border-radius:50%;background: #ffd86b;box-shadow:0 0 12px 3px rgba(255,200,100,0.08);animation:blink 1.6s infinite}
  @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}

  /* stage and canvas */
  #wrap{position:relative;z-index:2;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
  canvas{background:transparent;display:block;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,.6);}

  /* HUD */
  #hud{position:fixed;left:12px;top:12px;background:var(--hud-bg);padding:8px 12px;border-radius:10px;z-index:4;font-weight:700}
  #hud small{display:block;font-weight:400;color:#bcd2df;margin-top:6px}

  /* overlay & controls */
  #overlay{position:fixed;inset:0;z-index:6;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.55);gap:12px}
  .btn{background:var(--accent);border:none;padding:12px 18px;border-radius:10px;color:#022237;font-weight:800;cursor:pointer}
  #controls{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:space-around;z-index:5;padding:0 22px;pointer-events:none}
  .ctl{width:88px;height:88px;border-radius:50%;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-size:34px;color:var(--accent);user-select:none;touch-action:none}
  /* gameover */
  #gameover{position:fixed;inset:0;z-index:7;display:none;align-items:center;justify-content:center}
  .goBox{background:linear-gradient(180deg,#081827,#04202b);padding:20px;border-radius:10px;text-align:center}
  @media (max-width:640px){ canvas{width:92vw;height:calc(92vw * 1.6)} .ctl{width:72px;height:72px;font-size:28px} }
</style>
</head>
<body>

<!-- Parallax city -->
<div id="city" aria-hidden="true">
  <div class="layer far"></div>
  <div class="layer mid"></div>
  <div class="layer near"></div>
  <div class="lights">
    <div class="light" style="left:6%;animation-delay:0s"></div>
    <div class="light" style="left:18%;animation-delay:.2s"></div>
    <div class="light" style="left:32%;animation-delay:.4s"></div>
    <div class="light" style="left:50%;animation-delay:.6s"></div>
    <div class="light" style="left:68%;animation-delay:.9s"></div>
    <div class="light" style="left:82%;animation-delay:1.1s"></div>
  </div>
</div>

<!-- Stage -->
<div id="wrap">
  <canvas id="game" width="420" height="680" aria-label="Avtomobil o'yini"></canvas>
</div>

<!-- HUD -->
<div id="hud">
  Ball: <span id="score">0</span> &nbsp; Speed: <span id="spd">3.0</span>
  <small>‚Üê ‚Üí yoki ekranda tugmalar bilan boshqarish. Boshlash uchun START bosing.</small>
</div>

<!-- Overlay -->
<div id="overlay">
  <div style="font-size:22px;font-weight:900">üöó Mashina Jangi ‚Äî 3D & real tovush</div>
  <button id="startBtn" class="btn">START</button>
  <div style="font-size:13px;color:#bcd2df">Mobil: chap/ong tugmalar yoki svayp bilan boshqarish. Bosish bilan ovoz yoqiladi.</div>
</div>

<!-- Mobile controls -->
<div id="controls" style="pointer-events:none;display:none">
  <div id="leftBtn" class="ctl">‚óÄ</div>
  <div id="rightBtn" class="ctl">‚ñ∂</div>
</div>

<!-- Game over modal -->
<div id="gameover">
  <div class="goBox">
    <div style="font-size:20px;font-weight:900">üí• To'qnashuv! üí•</div>
    <div id="finalScore" style="margin-top:8px">Ball: 0</div>
    <button id="reBtn" class="btn">Qayta o'ynash</button>
  </div>
</div>

<!-- Audio files (online sources) -->
<!-- engine idle loop and rev sound from Pixabay (royalty-free) -->
<audio id="engineIdle" loop preload="auto"
  src="https://cdn.pixabay.com/download/audio/2021/09/28/audio_85ef77cb02.mp3?filename=car-engine-idle-loop-115591.mp3"></audio>
<audio id="engineRev" preload="auto"
  src="https://cdn.pixabay.com/download/audio/2021/10/05/audio_23b1b6b90a.mp3?filename=car-engine-rev-116109.mp3"></audio>
<audio id="crashAudio" preload="auto"
  src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c5f6c26c82.mp3?filename=impact-116026.mp3"></audio>

<script>
/* ========= GAME + AUDIO ========== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const controls = document.getElementById('controls');
const hudSpd = document.getElementById('spd');
const hudScore = document.getElementById('score');
const engineIdle = document.getElementById('engineIdle');
const engineRev = document.getElementById('engineRev');
const crashAudio = document.getElementById('crashAudio');
const gameoverModal = document.getElementById('gameover');
const finalScore = document.getElementById('finalScore');
const reBtn = document.getElementById('reBtn');

let W = canvas.width, H = canvas.height;
function scaleCanvas(){
  const scale = Math.min(window.innerWidth / W, window.innerHeight / H, 1);
  canvas.style.width = (W * scale) + 'px';
  canvas.style.height = (H * scale) + 'px';
}
window.addEventListener('resize', scaleCanvas);
scaleCanvas();

/* Game state */
let player = { x: 190, y: 560, w: 40, h: 70, speed: 6 };
let enemies = [];
let keys = {};
let movingLeft = false, movingRight = false;
let score = 0;
let baseSpeed = 3;
let speed = baseSpeed;
let tick = 0;
let running = false;
let lastSpawn = 0;
let laneX = [60,130,200,270];

/* Helper: rounded rect */
function roundedRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}

/* spawn enemy car */
function spawnEnemy(){
  const lane = laneX[Math.floor(Math.random()*laneX.length)];
  const colors = ['#e74c3c','#f39c12','#3498db','#9b59b6','#2ecc71'];
  enemies.push({ x: lane - 20, y: -120, w: 40, h: 80, color: colors[Math.floor(Math.random()*colors.length)], passed:false });
}

/* collision test */
function overlap(a,b){
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

/* draw scene */
let roadOffset = 0;
function drawScene(){
  // sky
  const sky = ctx.createLinearGradient(0,0,0,H*0.28);
  sky.addColorStop(0,'#071126'); sky.addColorStop(1,'#00141c');
  ctx.fillStyle = sky; ctx.fillRect(0,0,W,H);

  // sidewalks
  ctx.fillStyle = '#0f1724'; ctx.fillRect(0,80,40,H-160); ctx.fillRect(W-40,80,40,H-160);

  // road
  ctx.fillStyle = '#2b2b2b'; ctx.fillRect(40,80,W-80,H-160);

  // lane separators
  ctx.strokeStyle = '#999'; ctx.lineWidth = 4;
  ctx.beginPath(); ctx.moveTo(130,80); ctx.lineTo(130,H-80); ctx.moveTo(W-130,80); ctx.lineTo(W-130,H-80); ctx.stroke();

  // moving dashed center line
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 3;
  for (let y = - (roadOffset % 40); y < H; y += 40) {
    ctx.beginPath();
    ctx.moveTo(W/2 - 2, 80 + y);
    ctx.lineTo(W/2 - 2, 80 + y + 20);
    ctx.stroke();
  }
  roadOffset += speed;
}

/* draw player */
function drawPlayer(){
  roundedRect(player.x, player.y, player.w, player.h, 8);
  ctx.fillStyle = '#00ffcc'; ctx.fill();
  ctx.fillStyle = 'rgba(0,0,0,0.12)'; ctx.fillRect(player.x + 6, player.y + 10, player.w - 12, 22);
  ctx.fillStyle = '#111'; ctx.fillRect(player.x + 6, player.y + player.h - 10, 10, 6); ctx.fillRect(player.x + player.w - 16, player.y + player.h - 10, 10, 6);
}

/* draw enemies */
function drawEnemies(){
  for (let i = enemies.length - 1; i >= 0; i--){
    const e = enemies[i];
    roundedRect(e.x, e.y, e.w, e.h, 6);
    ctx.fillStyle = e.color; ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.12)'; ctx.fillRect(e.x + 5, e.y + 10, e.w - 10, 18);
    ctx.fillStyle = '#111'; ctx.fillRect(e.x + 6, e.y + e.h - 10, 10, 6); ctx.fillRect(e.x + e.w - 16, e.y + e.h - 10, 10, 6);
  }
}

/* end game */
function endGame(){
  running = false;
  // stop engine idle
  try{ engineIdle.pause(); engineIdle.currentTime = 0; } catch(e){}
  // crash sound
  try{ crashAudio.currentTime = 0; crashAudio.play().catch(()=>{}); } catch(e){}
  finalScore.textContent = 'Ball: ' + score;
  gameoverModal.style.display = 'flex';
}

/* main loop */
function loop(){
  if (!running) return;
  tick++;

  // input
  if ((keys['ArrowLeft'] || movingLeft) && player.x > 40) player.x -= player.speed;
  if ((keys['ArrowRight'] || movingRight) && player.x < W - player.w - 40) player.x += player.speed;

  // spawn - ensure not too frequent
  if (Date.now() - lastSpawn > 600 && Math.random() < 0.04) { spawnEnemy(); lastSpawn = Date.now(); }

  // update enemies
  for (let i = enemies.length - 1; i >= 0; i--){
    const e = enemies[i];
    e.y += speed;
    if (!e.passed && e.y > H) { e.passed = true; enemies.splice(i,1); score++; hudScore.textContent = score; }
    else {
      if (overlap(player, e)) { endGame(); return; }
    }
  }

  // difficulty: every 10 seconds increase speed
  // use tick with ~60fps assumption
  if (tick % Math.floor(60 * 10) === 0) {
    speed = Math.min(12, speed + 0.6);
    hudSpd.textContent = speed.toFixed(1);
    // play rev sound softly when speed increases
    try{ engineRev.currentTime = 0; engineRev.play().catch(()=>{}); } catch(e){}
    // slightly speed up engine idle (playbackRate) for better feel
    try{ engineIdle.playbackRate = 1 + (speed - baseSpeed) * 0.06; } catch(e){}
    // nudge parallax layers
    document.querySelectorAll('#city .layer').forEach((el, idx) => {
      el.style.transform = `translate3d(-50%,-${60 - idx*6}%, ${-300 + idx*120}px) rotateY(${(tick%100)/50 * (idx-1)}deg)`;
    });
  }

  // render
  ctx.clearRect(0,0,W,H);
  drawScene();
  drawPlayer();
  drawEnemies();

  requestAnimationFrame(loop);
}

/* controls: keyboard */
document.addEventListener('keydown', e => { keys[e.key] = true; });
document.addEventListener('keyup', e => { keys[e.key] = false; });

/* mobile touch buttons */
leftBtn.addEventListener('touchstart', e => { e.preventDefault(); movingLeft = true; });
leftBtn.addEventListener('touchend', e => { e.preventDefault(); movingLeft = false; });
rightBtn.addEventListener('touchstart', e => { e.preventDefault(); movingRight = true; });
rightBtn.addEventListener('touchend', e => { e.preventDefault(); movingRight = false; });

/* swipe on canvas */
let touchStartX = null;
canvas.addEventListener('touchstart', e => {
  if (!e.touches || !e.touches[0]) return;
  touchStartX = e.touches[0].clientX;
});
canvas.addEventListener('touchmove', e => {
  if (!e.touches || !e.touches[0] || touchStartX === null) return;
  const dx = e.touches[0].clientX - touchStartX;
  if (dx < -20) { movingLeft = true; movingRight = false; }
  else if (dx > 20) { movingRight = true; movingLeft = false; }
});
canvas.addEventListener('touchend', e => { movingLeft = false; movingRight = false; touchStartX = null; });

/* pointer for desktop/tap: press left/right half */
canvas.addEventListener('pointerdown', e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  if (x < rect.width / 2) movingLeft = true; else movingRight = true;
});
canvas.addEventListener('pointerup', () => { movingLeft = false; movingRight = false; });

/* START: enable audio + show controls + start loop */
startBtn.addEventListener('click', async () => {
  // allow audio: play engine idle (user gesture)
  try{
    engineIdle.currentTime = 0;
    engineIdle.volume = 0.28;
    await engineIdle.play();
  }catch(e){ /* ignore */ }

  overlay.style.display = 'none';
  // show mobile controls on small screens
  if (window.innerWidth <= 720) { controls.style.display = 'flex'; controls.style.pointerEvents = 'auto'; } else { controls.style.display = 'none'; }
  running = true;
  tick = 0;
  lastSpawn = Date.now();
  // ensure playbackRate baseline
  try{ engineIdle.playbackRate = 1; } catch(e){}
  loop();
});

/* RESTART */
reBtn.addEventListener('click', () => {
  enemies = []; score = 0; hudScore.textContent = 0; speed = baseSpeed; hudSpd.textContent = speed.toFixed(1);
  gameoverModal.style.display = 'none'; overlay.style.display = 'none';
  try{ engineIdle.currentTime = 0; engineIdle.play().catch(()=>{}); } catch(e){}
  running = true; tick = 0; lastSpawn = Date.now(); loop();
});

/* initial parallax transforms */
document.querySelectorAll('#city .layer').forEach((el, idx) => {
  el.style.transform = `translate3d(-50%,-${60 - idx*6}%, ${-300 + idx*120}px)`;
});

/* ensure canvas scaled */
scaleCanvas();
</script>
</body>
</html>
